"use strict";(self.webpackChunk_aws_portage_on_aws_website=self.webpackChunk_aws_portage_on_aws_website||[]).push([[5616],{4673:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var o=t(4848),a=t(8453);const r={sidebar_position:1},i="AWS Control Tower and AFT",s={id:"integration/control-tower-and-aft",title:"AWS Control Tower and AFT",description:"Introduction",source:"@site/docs/integration/control-tower-and-aft.md",sourceDirName:"integration",slug:"/integration/control-tower-and-aft",permalink:"/docs/integration/control-tower-and-aft",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Integration",permalink:"/docs/category/integration"},next:{title:"Git",permalink:"/docs/integration/git"}},c={},l=[{value:"Introduction",id:"introduction",level:3},{value:"Architecture",id:"architecture",level:2},{value:"Installing AWS Control Tower and AFT",id:"installing-aws-control-tower-and-aft",level:2},{value:"Integrating Portage on AWS to AFT",id:"integrating-portage-on-aws-to-aft",level:2},{value:"Introduction",id:"introduction-1",level:3},{value:"Step 1: Create Portage Management Account",id:"step-1-create-portage-management-account",level:3},{value:"Step 2: Deploy Portage",id:"step-2-deploy-portage",level:3},{value:"Step 3: Set up IAM Role for Application Account",id:"step-3-set-up-iam-role-for-application-account",level:3},{value:"Step 4: Create Application Account for Portage Integration",id:"step-4-create-application-account-for-portage-integration",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"aws-control-tower-and-aft",children:"AWS Control Tower and AFT"})}),"\n",(0,o.jsx)(n.h3,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsxs)(n.p,{children:["This article will describe how to inegrate Portage on AWS with AWS Control Tower and AFT-",(0,o.jsx)(n.a,{href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory",children:"Account Factory for Terraform"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsx)("p",{align:"center",children:(0,o.jsx)("img",{src:"/img/diagrams/aft-architecture.png"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"In the above architecture, we created a seprate OU to host IAC orchestration and an account for AFT to be deployed."}),"\n",(0,o.jsxs)(n.li,{children:["We can also use the same OU to host Portage on AWS Platform and it's platform artifacts - this is ",(0,o.jsx)(n.strong,{children:"not"})," for workload controlled accounts"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"installing-aws-control-tower-and-aft",children:"Installing AWS Control Tower and AFT"}),"\n",(0,o.jsxs)(n.p,{children:["AWS Control Tower: ",(0,o.jsx)(n.strong,{children:"Must be deployed in your environment"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Account Factory for Terraform (AFT): Must be deployed and configured with your Control Tower environment."}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["For setting up Control Tower, follow this ",(0,o.jsx)(n.a,{href:"https://docs.aws.amazon.com/controltower/latest/userguide/setting-up.html",children:"link"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["For integrating AFT with your Control Tower environment, follow this ",(0,o.jsx)(n.a,{href:"https://developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft",children:"link"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"integrating-portage-on-aws-to-aft",children:"Integrating Portage on AWS to AFT"}),"\n",(0,o.jsx)(n.h3,{id:"introduction-1",children:"Introduction"}),"\n",(0,o.jsx)(n.p,{children:'The AFT pipeline provide a process that create accounts by submitting a request to "account-requests" repository, as shown in the below diagram:'}),"\n",(0,o.jsx)("p",{align:"center",children:(0,o.jsx)("img",{src:"/img/diagrams/aft-pipeline.png"})}),"\n",(0,o.jsx)(n.p,{children:"The integration with Portage on AWS Platform is based on the principle of customization template - that creates a pre-baked role, that the platform / Portage pipeline can use to provision resources."}),"\n",(0,o.jsx)(n.h3,{id:"step-1-create-portage-management-account",children:"Step 1: Create Portage Management Account"}),"\n",(0,o.jsx)(n.p,{children:"This step is option. You can choose to deploy Portage in any existing account; however, we as a best practice we discourage doing so."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Create an AWS account within your Control Tower environment named ",(0,o.jsx)(n.code,{children:"Portage Management"}),". This account will host the Portage infrastructure."]}),"\n",(0,o.jsx)(n.li,{children:"AFT Repositories: AFT supports four repositories for account management and customizations:"}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"account_request_repo_name: Manages new account requests."}),"\n",(0,o.jsx)(n.li,{children:"global_customizations_repo_name: Applies customizations across all AFT-created accounts."}),"\n",(0,o.jsx)(n.li,{children:"account_customizations_repo_name: Customizes specific accounts."}),"\n",(0,o.jsx)(n.li,{children:"account_provisioning_customizations_repo_name: Sets up custom non-Terraform integrations pre-account provisioning."}),"\n"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Account Request:"}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Add an account request for the ",(0,o.jsx)(n.code,{children:"Portage Management"})," account in the account_request repository."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-request\n\u2502   \u2514\u2500\u2500 terraform\n\u2502       \u251c\u2500\u2500 aft-providers.jinja\n\u2502       \u251c\u2500\u2500 backend.jinja\n\u2502       \u251c\u2500\u2500 modules\n\u2502       \u2502   \u2514\u2500\u2500 aft-account-request\n\u2502       \u2502       \u251c\u2500\u2500 ddb.tf\n\u2502       \u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u2514\u2500\u2500 portage_account-request.tf\n"})}),"\n",(0,o.jsx)(n.p,{children:"portage_account-request.tf ->"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-terraform",children:'module "portage_account_admin" {\n  source = "./modules/aft-account-request"\n  \n  control_tower_parameters = {\n    AccountEmail              = "<email>"\n    AccountName               = "Portage Management"\n    ManagedOrganizationalUnit = "<ou>"\n    SSOUserEmail              = "<user-email>"\n    SSOUserFirstName          = "<first-name>"\n    SSOUserLastName           = "<last-name>"\n  }\n  \n  account_tags = {\n    "Owner"       = "<owner>"\n    "Division"    = "<division>"\n    "Environment" = "<env>"\n    "CostCenter"  = "<cost-center>"\n    "BUCode"      = "<bu-code>"\n    "Project"     = "Portage"\n  }\n  \n  change_management_parameters = {\n    change_requested_by = "Organization AWS Control Tower Admin"\n    change_reason       = "Deploy Portage Management Account to host Portage infrastructure"\n  }\n  \n  custom_fields = {\n    note = "This account will be used to deploy Portage management portal infrastructure"\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Push these changes to trigger account creation with AFT. Wait for completion before proceeding to Step 2."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"step-2-deploy-portage",children:"Step 2: Deploy Portage"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Access: Ensure you have access to the Portage management account with the necessary permissions to deploy required infrastructure."}),"\n",(0,o.jsxs)(n.li,{children:["Installation: Follow Portage installation steps via this ",(0,o.jsx)(n.a,{href:"/docs/getting-started/deploy-the-platform",children:"link"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"step-3-set-up-iam-role-for-application-account",children:"Step 3: Set up IAM Role for Application Account"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Automation with AFT: Use AFT for automating IAM role creation (",(0,o.jsx)(n.strong,{children:"PortageExecutionRole"}),") in the Application account, allowing Portage Management account to manage resources."]}),"\n",(0,o.jsx)(n.li,{children:"Customization Code:"}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Specify this as a template (",(0,o.jsx)(n.strong,{children:"Portage_INTEGRATION"}),") in the Account Customization AFT repository."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-customizations\n\u2502   \u2514\u2500\u2500 Portage_INTEGRATION\n\u2502       \u251c\u2500\u2500 api_helpers\n\u2502       \u2502   \u251c\u2500\u2500 post-api-helpers.sh\n\u2502       \u2502   \u251c\u2500\u2500 pre-api-helpers.sh\n\u2502       \u2502   \u2514\u2500\u2500 python\n\u2502       \u2502       \u2514\u2500\u2500 requirements.txt\n\u2502       \u2514\u2500\u2500 terraform\n\u2502           \u251c\u2500\u2500 aft-providers.jinja\n\u2502           \u251c\u2500\u2500 backend.jinja\n\u2502           \u2514\u2500\u2500 main.tf\n"})}),"\n",(0,o.jsx)(n.p,{children:"main.tf ->"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-terraform",children:'data "aws_ssm_parameter" "portage_org_id" {\n  name = "/aft/account-request/custom-fields/portage-org-id"\n}\n\ndata "aws_ssm_parameter" "aft_management_account_id" {\n  name = "/aft/account-request/custom-fields/portage-account-id"\n}\n\ndata "aws_ssm_parameter" "portage_pipeline_role" {\n  name = "/aft/account-request/custom-fields/portage-pipeline-role"\n}\n\ndata "aws_ssm_parameter" "portage_platform_role" {\n  name = "/aft/account-request/custom-fields/portage-platform-role"\n}\n\ndata "aws_iam_policy_document" "assume_role_policy" {\n  statement {\n    effect  = "Allow"\n\n    principals {\n      type        = "AWS"\n      identifiers = [\n        data.aws_ssm_parameter.portage_platform_role.value,\n        data.aws_ssm_parameter.portage_pipeline_role.value\n      ]\n    }\n\n    actions = ["sts:AssumeRole"]\n\n  }\n}\n\nresource "aws_iam_role" "admin_role" {\n  name               = "PortageExecutionRole"\n  assume_role_policy = data.aws_iam_policy_document.assume_role_policy.json\n}\n\nresource "aws_iam_role_policy_attachment" "admin_attach" {\n  role       = aws_iam_role.admin_role.name\n  policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Push Customization Code: Update the specified account customization repository with this code."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Portage Management Account Iam role flow with Application account",src:t(3412).A+"",width:"1593",height:"513"})}),"\n",(0,o.jsx)(n.h3,{id:"step-4-create-application-account-for-portage-integration",children:"Step 4: Create Application Account for Portage Integration"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Account Request:"}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Create an Application account creation request tailored for Portage on AWS."}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-request\n\u2502   \u2514\u2500\u2500 terraform\n\u2502       \u251c\u2500\u2500 aft-providers.jinja\n\u2502       \u251c\u2500\u2500 backend.jinja\n\u2502       \u251c\u2500\u2500 modules\n\u2502       \u2502   \u2514\u2500\u2500 aft-account-request\n\u2502       \u2502       \u251c\u2500\u2500 ddb.tf\n\u2502       \u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u251c\u2500\u2500 portage_moderated_account1.tf\n\u2502       \u2514\u2500\u2500 portage_account-request.tf\n"})}),"\n",(0,o.jsx)(n.p,{children:"portage_moderated_account1.tf->"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-terraform",children:'module "portage_app_account_1" {\n  source = "./modules/aft-account-request"\n\n  control_tower_parameters = {\n    AccountEmail              = ""\n    AccountName               = "Portage Application Account 1"\n    ManagedOrganizationalUnit = "Sandbox"\n    SSOUserEmail              = ""\n    SSOUserFirstName          = ""\n    SSOUserLastName           = ""\n  }\n\n  account_tags = {\n    "Owner"       = ""\n    "Division"    = ""\n    "Environment" = ""\n    "CostCenter"  = ""\n    "BUCode"      = ""\n    "Project"     = "Portage"\n  }\n\n  change_management_parameters = {\n    change_requested_by = "Organization AWS Control Tower Admin"\n    change_reason       = "Deploy Portage Application Account 1"\n  }\n\n  custom_fields = {\n    note = "This account will be used to deploy applications from Portage management portal"\n    portage-org-id = "Portage_ORG_ID"\n    portage-account-id = "Portage_ACCOUNT_ID"\n    portage-pipeline-role = "Portage_PIPELINE_IAM_ROLE"\n    portage-platform-role = "arn:aws:iam::Portage_ACCOUNT_ID:role/backstage-master-role"\n  }\n\n  account_customizations_name = "Portage_INTEGRATION"\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note"}),": We are using custom_fields here to inject variables that will be used by the Account Customization Portage_INTEGRATION template"]}),"\n",(0,o.jsx)(n.p,{children:"The actual values for these variable needs to be fetched from the Portage management account and Control Tower management account"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Login to the Portage Management account under the IAM service and Role. Copy the portage-pipeline-role and portage-platform-role"}),"\n",(0,o.jsx)(n.li,{children:"Login to the Control Tower management account. From the Control Tower service -> Organization tab, copy the Portage management account ID and the Organization ID that the Portage management account is part of."}),"\n"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Completion:"}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Push the request to the Account Request repo and wait for account creation to complete."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Congratulations! You have successfully set up an Application account ready for Portage integration. For deploying applications using Portage, follow this ",(0,o.jsx)(n.a,{href:"/docs/getting-started/videos",children:"link"}),"."]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},3412:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/opa-iam-role-9d2f00ac7dd1332f78a94abdbce4c0c2.png"},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>s});var o=t(6540);const a={},r=o.createContext(a);function i(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);